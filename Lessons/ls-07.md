# Lesson 7: Connecting Everything

> **Progress**: `[â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘]` 70%  
> **Time**: ~15 minutes

---

## ğŸ¯ Learning Objectives

- Run the complete end-to-end pipeline
- Add reconnection logic to Node.js client
- Implement health checks
- Create a simple run script
- Troubleshoot common issues

---

## 1. Complete Architecture Review

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COMPLETE SYSTEM                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚ Go Producer  â”‚  (Terminal 3)                                 â”‚
â”‚  â”‚              â”‚                                               â”‚
â”‚  â”‚ Generates    â”‚                                               â”‚
â”‚  â”‚ test data    â”‚                                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚         â”‚                                                       â”‚
â”‚         â–¼                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚            Kafka Topic               â”‚                       â”‚
â”‚  â”‚          payments.raw                â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                     â”‚                                           â”‚
â”‚                     â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  (Terminal 1)         â”‚
â”‚  â”‚          Go Server                   â”‚                       â”‚
â”‚  â”‚                                      â”‚                       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                       â”‚
â”‚  â”‚  â”‚   Kafka     â”‚  â”‚    gRPC       â”‚  â”‚                       â”‚
â”‚  â”‚  â”‚  Consumer   â”‚â”€â–¶â”‚   Server      â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  â”‚             â”‚  â”‚   :50051      â”‚  â”‚       â”‚               â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚               â”‚
â”‚  â”‚                                      â”‚       â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚               â”‚
â”‚                                                 â”‚               â”‚
â”‚                                                 â–¼               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  (Terminal 2)         â”‚
â”‚  â”‚        Node.js Client                â”‚                       â”‚
â”‚  â”‚                                      â”‚                       â”‚
â”‚  â”‚  Subscribes to StreamPayments        â”‚                       â”‚
â”‚  â”‚  Logs each payment one at a time     â”‚                       â”‚
â”‚  â”‚                                      â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Project Structure (Final)

```
payment-aggregator/
â”œâ”€â”€ proto/
â”‚   â””â”€â”€ payment.proto
â”œâ”€â”€ go-service/
â”‚   â”œâ”€â”€ .env
â”‚   â”œâ”€â”€ go.mod
â”‚   â”œâ”€â”€ cmd/
â”‚   â”‚   â”œâ”€â”€ producer/main.go
â”‚   â”‚   â””â”€â”€ server/main.go
â”‚   â”œâ”€â”€ internal/
â”‚   â”‚   â”œâ”€â”€ config/config.go
â”‚   â”‚   â”œâ”€â”€ grpc/server.go
â”‚   â”‚   â””â”€â”€ kafka/
â”‚   â”‚       â”œâ”€â”€ consumer.go
â”‚   â”‚       â”œâ”€â”€ producer.go
â”‚   â”‚       â””â”€â”€ message.go
â”‚   â””â”€â”€ pb/
â”‚       â”œâ”€â”€ payment.pb.go
â”‚       â””â”€â”€ payment_grpc.pb.go
â”œâ”€â”€ node-service/
â”‚   â”œâ”€â”€ .env
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â”œâ”€â”€ proto/payment.proto
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ index.ts
â”‚       â”œâ”€â”€ client.ts
â”‚       â”œâ”€â”€ config.ts
â”‚       â””â”€â”€ logger.ts
â”œâ”€â”€ Makefile
â””â”€â”€ README.md
```

---

## 3. Add Reconnection to Node.js Client

Update `node-service/src/client.ts` to handle reconnection:

```typescript
import * as grpc from '@grpc/grpc-js';
import * as protoLoader from '@grpc/proto-loader';
import { config } from './config';
import { PaymentEvent } from './logger';

const PROTO_OPTIONS: protoLoader.Options = {
  keepCase: false,
  longs: String,
  enums: Number,
  defaults: true,
  oneofs: true,
};

const packageDefinition = protoLoader.loadSync(config.proto.path, PROTO_OPTIONS);
const protoDescriptor = grpc.loadPackageDefinition(packageDefinition) as any;
const PaymentService = protoDescriptor.payment.PaymentService;

export class PaymentClient {
  private client: any;
  private connected: boolean = false;
  private reconnecting: boolean = false;
  private stream: grpc.ClientReadableStream<PaymentEvent> | null = null;

  // Callbacks for streaming
  private onPaymentCallback?: (event: PaymentEvent) => void;
  private onErrorCallback?: (err: Error) => void;

  constructor() {
    this.createClient();
  }

  private createClient(): void {
    this.client = new PaymentService(
      config.grpc.address,
      grpc.credentials.createInsecure(),
      {
        'grpc.keepalive_time_ms': 10000,
        'grpc.keepalive_timeout_ms': 5000,
        'grpc.keepalive_permit_without_calls': 1,
      }
    );
  }

  async connect(timeoutMs: number = 5000): Promise<void> {
    return new Promise((resolve, reject) => {
      const deadline = Date.now() + timeoutMs;
      
      this.client.waitForReady(deadline, (err: Error | undefined) => {
        if (err) {
          reject(new Error(`Failed to connect: ${err.message}`));
        } else {
          this.connected = true;
          console.log(`âœ… Connected to gRPC server at ${config.grpc.address}`);
          resolve();
        }
      });
    });
  }

  /**
   * Stream payments with automatic reconnection
   */
  streamPaymentsWithReconnect(
    onPayment: (event: PaymentEvent) => void,
    onError?: (err: Error) => void,
    options: { provider?: number; maxRetries?: number; retryDelayMs?: number } = {}
  ): void {
    const maxRetries = options.maxRetries ?? 10;
    const retryDelayMs = options.retryDelayMs ?? 3000;
    let retryCount = 0;

    this.onPaymentCallback = onPayment;
    this.onErrorCallback = onError;

    const startStream = () => {
      if (this.reconnecting) return;

      this.stream = this.client.streamPayments({
        provider: options.provider || 0,
        status: 0,
        limit: 0,
      });

      this.stream!.on('data', (event: PaymentEvent) => {
        retryCount = 0; // Reset on successful data
        this.onPaymentCallback?.(event);
      });

      this.stream!.on('error', (err: Error) => {
        const errCode = (err as any).code;
        
        // CANCELLED means intentional close
        if (errCode === grpc.status.CANCELLED) {
          return;
        }

        console.error(`\nâŒ Stream error (code ${errCode}):`, err.message);

        // Attempt reconnection for recoverable errors
        if (errCode === grpc.status.UNAVAILABLE || 
            errCode === grpc.status.UNKNOWN ||
            errCode === grpc.status.INTERNAL) {
          
          if (retryCount < maxRetries) {
            retryCount++;
            this.reconnecting = true;
            console.log(`ğŸ”„ Reconnecting in ${retryDelayMs/1000}s (attempt ${retryCount}/${maxRetries})...`);
            
            setTimeout(() => {
              this.reconnecting = false;
              this.createClient();
              this.connect()
                .then(() => startStream())
                .catch((e) => {
                  console.error('âŒ Reconnection failed:', e.message);
                  if (retryCount >= maxRetries) {
                    this.onErrorCallback?.(new Error('Max retries exceeded'));
                  }
                });
            }, retryDelayMs);
          } else {
            this.onErrorCallback?.(new Error('Max retries exceeded'));
          }
        } else {
          this.onErrorCallback?.(err);
        }
      });

      this.stream!.on('end', () => {
        console.log('ğŸ“ª Stream ended by server');
        // Server closed stream - try to reconnect
        if (!this.reconnecting && retryCount < maxRetries) {
          retryCount++;
          console.log(`ğŸ”„ Stream ended, reconnecting in ${retryDelayMs/1000}s...`);
          setTimeout(() => startStream(), retryDelayMs);
        }
      });
    };

    startStream();
  }

  /**
   * Get a single payment by ID
   */
  async getPayment(paymentId: string): Promise<any> {
    return new Promise((resolve, reject) => {
      this.client.getPayment({ paymentId }, (err: Error, response: any) => {
        if (err) reject(err);
        else resolve(response);
      });
    });
  }

  /**
   * List payments
   */
  async listPayments(options: { provider?: number; status?: number; limit?: number } = {}): Promise<any> {
    return new Promise((resolve, reject) => {
      this.client.listPayments(
        { provider: options.provider || 0, status: options.status || 0, limit: options.limit || 10 },
        (err: Error, response: any) => {
          if (err) reject(err);
          else resolve(response);
        }
      );
    });
  }

  /**
   * Cancel active stream
   */
  cancelStream(): void {
    if (this.stream) {
      this.stream.cancel();
      this.stream = null;
    }
  }

  /**
   * Close connection
   */
  close(): void {
    this.cancelStream();
    this.client.close();
    this.connected = false;
    console.log('ğŸ‘‹ Disconnected from gRPC server');
  }
}
```

---

## 4. Update Node.js Entry Point

Update `node-service/src/index.ts`:

```typescript
import { PaymentClient } from './client';
import { logPaymentSimple, PaymentEvent } from './logger';
import { config } from './config';

let stats = {
  existing: 0,
  new: 0,
  total: 0,
  startTime: Date.now(),
};

async function main() {
  console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           PAYMENT gRPC CLIENT (Node.js)                       â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Connecting to: ${config.grpc.address.padEnd(43)}â•‘
â•‘  Auto-reconnect: enabled                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
`);

  const client = new PaymentClient();

  try {
    await client.connect();

    console.log('\nğŸ“¡ Subscribing to payment stream (with auto-reconnect)...\n');
    console.log('â”€'.repeat(65));

    // Use reconnecting stream
    client.streamPaymentsWithReconnect(
      (event: PaymentEvent) => {
        stats.total++;
        if (event.eventType === 'new') stats.new++;
        else stats.existing++;
        logPaymentSimple(event);
      },
      (err: Error) => {
        console.error('\nâŒ Fatal error:', err.message);
        printStats();
        process.exit(1);
      },
      {
        maxRetries: 10,
        retryDelayMs: 3000,
      }
    );

    // Graceful shutdown
    const shutdown = () => {
      console.log('\n\nâ³ Shutting down...');
      client.close();
      printStats();
      process.exit(0);
    };

    process.on('SIGINT', shutdown);
    process.on('SIGTERM', shutdown);

    console.log('Waiting for payments... (Ctrl+C to stop)\n');

  } catch (err) {
    console.error('âŒ Failed to start:', err);
    process.exit(1);
  }
}

function printStats() {
  const duration = ((Date.now() - stats.startTime) / 1000).toFixed(1);
  console.log(`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SESSION STATS                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Total Payments:    ${String(stats.total).padEnd(38)}â”‚
â”‚  Existing:          ${String(stats.existing).padEnd(38)}â”‚
â”‚  New:               ${String(stats.new).padEnd(38)}â”‚
â”‚  Duration:          ${(duration + 's').padEnd(38)}â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜`);
}

main();
```

---

## 5. Create Run Scripts

### Makefile (root directory)

```makefile
.PHONY: proto go-deps node-deps server producer client all clean

# Proto generation
proto:
	protoc --go_out=go-service/pb --go_opt=paths=source_relative \
	       --go-grpc_out=go-service/pb --go-grpc_opt=paths=source_relative \
	       proto/payment.proto
	cp proto/payment.proto node-service/proto/

# Install Go dependencies
go-deps:
	cd go-service && go mod tidy

# Install Node dependencies
node-deps:
	cd node-service && npm install

# Start Go server
server:
	cd go-service && go run cmd/server/main.go

# Run producer
producer:
	cd go-service && go run cmd/producer/main.go -count=10 -interval=1s

# Start Node.js client
client:
	cd node-service && npm run dev

# Install all dependencies
deps: go-deps node-deps

# Full setup
setup: proto deps

# Clean generated files
clean:
	rm -f go-service/pb/*.go
	rm -rf node-service/dist
	rm -rf node-service/node_modules
```

### run.sh (root directory)

```bash
#!/bin/bash

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${GREEN}â•‘          Payment Aggregator - Quick Start                     â•‘${NC}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

case "$1" in
  setup)
    echo -e "${YELLOW}Setting up project...${NC}"
    make setup
    echo -e "${GREEN}âœ… Setup complete!${NC}"
    ;;
  server)
    echo -e "${YELLOW}Starting Go gRPC server...${NC}"
    cd go-service && go run cmd/server/main.go
    ;;
  client)
    echo -e "${YELLOW}Starting Node.js client...${NC}"
    cd node-service && npm run dev
    ;;
  producer)
    COUNT=${2:-5}
    echo -e "${YELLOW}Sending ${COUNT} test payments...${NC}"
    cd go-service && go run cmd/producer/main.go -count=$COUNT -interval=1s
    ;;
  *)
    echo "Usage: $0 {setup|server|client|producer [count]}"
    echo ""
    echo "Commands:"
    echo "  setup     - Install dependencies and generate proto"
    echo "  server    - Start Go gRPC server"
    echo "  client    - Start Node.js streaming client"
    echo "  producer  - Send test payments (default: 5)"
    echo ""
    echo "Quick start (run in separate terminals):"
    echo "  Terminal 1: ./run.sh server"
    echo "  Terminal 2: ./run.sh client"
    echo "  Terminal 3: ./run.sh producer 10"
    ;;
esac
```

Make it executable:
```bash
chmod +x run.sh
```

---

## 6. End-to-End Test

### Step 1: Setup (first time only)

```bash
# From root directory
./run.sh setup
# OR
make setup
```

### Step 2: Start Server (Terminal 1)

```bash
./run.sh server
```

**Expected output:**
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         PAYMENT gRPC SERVER                â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ gRPC:   :50051                             â•‘
â•‘ Kafka:  payments.raw                       â•‘
â•‘ SSL:    true                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[KAFKA] âœ… Consumer started
Press Ctrl+C to stop
```

### Step 3: Start Client (Terminal 2)

```bash
./run.sh client
```

**Expected output:**
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           PAYMENT gRPC CLIENT (Node.js)                       â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Connecting to: localhost:50051                               â•‘
â•‘  Auto-reconnect: enabled                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Connected to gRPC server at localhost:50051

ğŸ“¡ Subscribing to payment stream (with auto-reconnect)...

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Waiting for payments... (Ctrl+C to stop)
```

### Step 4: Send Payments (Terminal 3)

```bash
./run.sh producer 10
```

**Expected output (Terminal 3):**
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘       PAYMENT PRODUCER (Test Data)         â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Broker: your-broker-url:9092               â•‘
â•‘ Topic:  payments.raw                       â•‘
â•‘ SSL:    true                               â•‘
â•‘ Count:  10                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[SEND] pay_abc123 | stripe | 150.00 usd
[PRODUCER] âœ… Delivered: pay_abc123 [partition 0]
...
```

**Watch Terminal 2 (Node.js):**
```
ğŸ†• [2024-01-15T10:30:05.123Z] pay_abc123 | STRIPE | $1.50 USD | COMPLETED
ğŸ†• [2024-01-15T10:30:06.456Z] pay_def456 | RAZORPAY | â‚¹1500.00 INR | PENDING
ğŸ†• [2024-01-15T10:30:07.789Z] pay_ghi789 | PAYPAL | â‚¬80.00 EUR | COMPLETED
```

---

## 7. Test Reconnection

### Test 1: Restart Server

1. Stop Go server (Ctrl+C in Terminal 1)
2. Watch Node.js client (Terminal 2):
   ```
   âŒ Stream error (code 14): Connection refused
   ğŸ”„ Reconnecting in 3s (attempt 1/10)...
   ```
3. Restart Go server
4. Node.js auto-reconnects:
   ```
   âœ… Connected to gRPC server at localhost:50051
   ```

### Test 2: Kill Producer Mid-Stream

This is fine - the stream stays open, just no new payments arrive.

---

## 8. Common Issues & Fixes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TROUBLESHOOTING                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ ISSUE: "Cannot connect to gRPC server"                         â”‚
â”‚ FIX:   1. Is Go server running? (./run.sh server)              â”‚
â”‚        2. Check port 50051 is not in use                       â”‚
â”‚        3. Check .env has correct GRPC_SERVER_HOST              â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ ISSUE: "Kafka connection failed"                               â”‚
â”‚ FIX:   1. Check go-service/.env has correct KAFKA_BROKERS      â”‚
â”‚        2. Verify KAFKA_SASL_USERNAME and PASSWORD              â”‚
â”‚        3. Check KAFKA_SSL=true if using SSL                    â”‚
â”‚        4. Ensure topic exists                                  â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ ISSUE: "Proto file not found" (Node.js)                        â”‚
â”‚ FIX:   1. Run: cp proto/payment.proto node-service/proto/      â”‚
â”‚        2. Or run: make proto                                   â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ ISSUE: "No payments appearing in Node.js"                      â”‚
â”‚ FIX:   1. Check Go server logs - is Kafka consuming?           â”‚
â”‚        2. Run producer: ./run.sh producer 5                    â”‚
â”‚        3. Check KAFKA_TOPIC matches in both .env files         â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ ISSUE: "Stream ends immediately"                               â”‚
â”‚ FIX:   1. Server-side issue - check Go server logs             â”‚
â”‚        2. Node.js should auto-reconnect                        â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚ ISSUE: "Module not found" errors                               â”‚
â”‚ FIX:   1. Go: cd go-service && go mod tidy                     â”‚
â”‚        2. Node: cd node-service && npm install                 â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. Quick Commands Reference

```bash
# Setup (first time)
./run.sh setup

# Run everything (3 terminals)
./run.sh server     # Terminal 1
./run.sh client     # Terminal 2  
./run.sh producer 5 # Terminal 3

# Individual commands
make proto          # Regenerate proto files
make go-deps        # Update Go dependencies
make node-deps      # Update Node dependencies

# Test gRPC directly
grpcurl -plaintext localhost:50051 list
grpcurl -plaintext localhost:50051 payment.PaymentService/ListPayments
grpcurl -plaintext -d '{"payment_id":"pay_001"}' localhost:50051 payment.PaymentService/GetPayment
```

---

**Common questions:**
- "How do I add TLS to gRPC?"
- "How do I monitor the system?"
- "Can I run this in Docker?"